{exp:channel:entries url_title="{embed:url_title}" limit="1"}

{embed="_embeds/_header" html_title="{title}" meta_description="{article_subtitle}"}

<div class="line">
	<div class="headline-block">
		{if article_photo_credit_link}
		<div class="photo-credit">
			Photo Credit: <a href="{article_photo_credit_link}">{article_photo_credit_text}</a>
		</div>
		{/if}
		{exp:ed_imageresizer image="{article_image}" maxWidth="800" forceWidth="yes" cropratio="16:9" }
		<div class="text">
			<div class="text-inner">
				<h1 class="h1">{title}</h1>
				<h2 class="h5">By Judy Fujimura, M.A.</h2>
				{if category_count != 0}
				<h2>Topics: 
					{categories backspace="1"}<a href="#">{category_name}</a>,{/categories}
				</h2>
				{/if}
			</div>
		</div>
	</div>
</div>

<div class="line">
	<div class="mod-wrapper">
		<div class="mod" data-padding="extra" data-bg-style="white">
			<div class="bd">

				{exp:scm_access entry_id="{entry_id}"}
					{if article_is_premium == "Yes"}

						{if no_access}

							{premium_article_blurb}...
							
							{if logged_in}
							
								{exp:simple_commerce:purchase entry_id="{entry_id}" success="/articles/{url_title}" cancel="/articles/{url_title}"}
									<a class="button button-primary" href="{buy_now_url}">Purchase for ${item_regular_price}</a>
								{/exp:simple_commerce:purchase}
							
							{if:else}
										
								<?php
									$login_stage = isset($_GET['login_stage']) ? $_GET['login_stage'] : false;

									if($login_stage == "email") :
								?>

									<form method="GET">
								        <dl class="info">
							                <dt class="h6">My Email Address is...</dt>
							                <dd><input type="text" name="email" value=""></dd>
							                <dt class="h6"><label>My password</label></dt>
							                <dd>
							                	<input type="radio" name="registered" id="false" value="false" checked>
												<label for="no">I don't have a password yet, I want to register</label><br/>
												<input type="radio" name="registered" id="true" value="true">
												<label for="yes">I have a password, I want to sign in</label>
						                		</dd>
							                <dt></dt>
							                <dd>
							                	<input type="hidden" name="login_stage" value="password">
							                	<input class="button" type="submit" name="submit" value="Sign in"><br/>
							                </dd>
							            </dl>
									</form>

								<?php elseif($login_stage == "password") : ?>

									<!-- User has entered their email and told us if they have an account -->

									<?php
										$email = isset($_GET['email']) ? $_GET['email'] : false;
										$registered = isset($_GET['registered']) ? $_GET['registered'] : false;

										if ($registered == "true") :
									?>
										
										<!-- User has an account. Show password field and log them in. -->
										
										{exp:member:login_form return="/articles/{url_title}"}

											<dl class="info">
										        <dt class="h6">My Password</dt>
										        <dd>
										        	<input id="password" type="password" name="password" value=""/><br/>
										        </dd>
										        <dt></dt>
										        <dd>
													<input type="hidden" name="username" value="<?php echo $email; ?>" />
										        	<input class="button" type="submit" name="submit" value="Sign in"><br/><br/>
										        	<a href="?login_stage=password&registered=false&username=<?php echo $email; ?>">Wait! I don't have a password</a><br/>
										        	<a href="{path='member/forgot_password'}">I forgot my password</a>
										        </dd>
										    </dl>

										{/exp:member:login_form}

									<?php else : ?>

										<!-- User doesn't have an account. Show register field and log them in after register. -->

										<?php $action_id = $this->EE->functions->fetch_action_id('Member', 'register_member'); ?>

										<form method="post" action="/"  >
											<input type="hidden" name="XID" value="{XID_HASH}" />
											<input type="hidden" name="ACT" value="<?php echo $action_id; ?>" />
											<input type="hidden" name="RET" value="/articles/{url_title}" />
											<input type="hidden" name="FROM" value="" />
											<input type="hidden" name="username" value="<?php echo $email; ?>" />
											<input type="hidden" name="email" value="<?php echo $email; ?>" />

											<dl class="info">
								                <dt class="h6">Choose a Password</dt>
								                <dd><input id="password" type="password" name="password" value="" maxlength="32" class="input" size="25" /></dd>
								                <dt class="h6">Confirm Password</dt>
								                <dd><input id="confirm" type="password" name="password_confirm" value="" maxlength="32" class="input" size="25" /></dd>
								                <dt></dt>
								                <dd>
								                	<input class="button" type="submit" name="submit" value="Sign in"><br/>
								                	<a href="?login_stage=password&registered=true&username=<?php echo $email; ?>">Wait! I already have a password</a>
								               	</dd>
								            </dl>
										</form> 
									
									<?php endif; ?>


								<?php else : ?>

									{exp:simple_commerce:purchase entry_id="{entry_id}" success="/articles/{url_title}" cancel="/articles/{url_title}"}
										<a class="button button-primary" href="?login_stage=email">Purchase for ${item_regular_price}</a>
									{/exp:simple_commerce:purchase}

								<?php endif; ?>
							{/if}
						{if:else}
							<div>
								Thank you for purchasing this premium content.
							</div>
							{article_body}			
						{/if}
					{if:else}
						{article_body}			
					{/if}
				{/exp:scm_access}
			</div>
		</div>
	</div>
</div>

{/exp:channel:entries}

{embed="_embeds/_footer"}
